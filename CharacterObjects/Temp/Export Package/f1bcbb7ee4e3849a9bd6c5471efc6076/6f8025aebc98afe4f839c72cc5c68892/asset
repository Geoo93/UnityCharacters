using UnityEngine;
using System.Collections;

public class FPSWalker : MonoBehaviour {

    float speed = 6.0f;
    float jumpSpeed = 8.0f;
    float gravity = 20.0f;

    public Vector3 moveDirection = Vector3.zero;
	public Vector3 oldMoveDirection = Vector3.zero;
    public bool ISGROUNDED = false;
    public bool CANJUMP = true;
	
	public static bool Swim;
	public GameObject Cam;
	public AudioSource AS;

    CharacterController controller;
	
	public static bool IsMoving;
	public static Vector3 MoveDir;
	
	public GameObject WaterPlane;

    void Start()
    {
        controller = GetComponent<CharacterController>();
    }

    void Update()
    {
		if(!SceneIntro.IntroPlayed)
			return;
		
            if (ISGROUNDED) { CANJUMP = true; }
            else { CANJUMP = false; }

			Swim = FXWaterEvents.IsSwiming;
			if(!Swim) {
			
	            if (ISGROUNDED)
	            {
					if(AS.isPlaying)
						AS.Stop();
				
	                moveDirection = new Vector3(Input.GetAxis("Horizontal"), 0, Input.GetAxis("Vertical"));
	                moveDirection = transform.TransformDirection(moveDirection);
	                moveDirection *= speed;
	
	                if (Input.GetButton("Jump"))
	                {
	                    moveDirection.y = jumpSpeed;
	                }
	            } else {
	            	moveDirection.y -= gravity * Time.deltaTime;
				}
			} else {
				if(IsMoving) {
					if(!AS.isPlaying)
						AS.Play();
				} else {
					if(AS.isPlaying)
						AS.Pause();
				}
			
				moveDirection = Cam.transform.forward * Input.GetAxis("Vertical");
				moveDirection += Cam.transform.right * (Input.GetAxis("Horizontal") / 2);
	            moveDirection *= speed;
			}

			if(moveDirection.magnitude > 1.0f) {
				IsMoving = true;
			} else {
				IsMoving = false;
			}
		
			MoveDir = moveDirection.normalized *-1;

            var flags = controller.Move(moveDirection * Time.deltaTime);
            ISGROUNDED = (flags & CollisionFlags.CollidedBelow) != 0;
			oldMoveDirection = moveDirection;
    }
	
	void OnGUI() {
		if(Application.isPlaying) {
			Screen.lockCursor = true;
		} else {
			Screen.lockCursor = false;
		}
	}
	
}
